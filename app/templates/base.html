<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}PEA Tracker{% endblock %}</title>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">

    <!-- CSRF token for HTMX -->
    <meta name="csrf-token" content="{{ csrf_token() }}">

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script>
        document.addEventListener('htmx:configRequest', function(evt) {
            var token = document.querySelector('meta[name="csrf-token"]');
            if (token) {
                evt.detail.headers['X-CSRFToken'] = token.getAttribute('content');
            }
        });
    </script>

    {% block head %}{% endblock %}
</head>
<body>
    {% if current_user.is_authenticated %}
    <div class="app">
        <!-- Sidebar (desktop) -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="{{ url_for('portfolio.dashboard') }}" class="sidebar-logo">
                    <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="28" height="28" rx="8" fill="var(--accent-primary-muted)"/>
                        <path d="M7 20V12L11 8L15 13L19 6L22 11V20H7Z" fill="var(--accent-primary)" opacity="0.3"/>
                        <path d="M7 18L11 13L15 16L22 8" stroke="var(--accent-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span class="sidebar-logo-text">PEA <span>Tracker</span></span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <a href="{{ url_for('portfolio.dashboard') }}"
                   class="nav-link"
                   {% if request.endpoint and 'dashboard' in request.endpoint %}aria-current="page"{% endif %}>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="3" width="7" height="7" rx="1"/>
                        <rect x="3" y="14" width="7" height="7" rx="1"/>
                        <rect x="14" y="14" width="7" height="7" rx="1"/>
                    </svg>
                    <span class="nav-link-text">Dashboard</span>
                </a>

                <a href="{{ url_for('portfolio.transactions') }}"
                   class="nav-link"
                   {% if request.endpoint and 'transaction' in request.endpoint %}aria-current="page"{% endif %}>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="7 17 17 7"/>
                        <polyline points="7 7 17 7 17 17"/>
                    </svg>
                    <span class="nav-link-text">Transactions</span>
                </a>

                <a href="{{ url_for('alerts.list_alerts') }}"
                   class="nav-link"
                   {% if request.endpoint and 'alert' in request.endpoint %}aria-current="page"{% endif %}>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    <span class="nav-link-text">Alertes</span>
                    {% if pending_backfills > 0 %}
                    <span class="nav-badge">!</span>
                    {% endif %}
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-user-avatar">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <span class="sidebar-user-email">{{ current_user.email }}</span>
                </div>
                <a href="{{ url_for('auth.logout') }}" class="sidebar-logout">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Déconnexion
                </a>
            </div>
        </aside>

        <!-- Mobile header -->
        <header class="mobile-header">
            <a href="{{ url_for('portfolio.dashboard') }}" class="mobile-header-logo">
                <svg width="24" height="24" viewBox="0 0 28 28" fill="none">
                    <rect width="28" height="28" rx="8" fill="var(--accent-primary-muted)"/>
                    <path d="M7 18L11 13L15 16L22 8" stroke="var(--accent-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                PEA <span>Tracker</span>
            </a>
        </header>

        <!-- Main content -->
        <main class="main-content">
            <!-- Toast notifications -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="toast-container">
                {% for category, message in messages %}
                <div class="toast {{ category }}" role="alert">
                    {% if category == 'success' %}
                    <svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    {% elif category in ['error', 'danger'] %}
                    <svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                    {% elif category == 'warning' %}
                    <svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    {% else %}
                    <svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    {% endif %}
                    <span class="toast-message">{{ message }}</span>
                    <button class="toast-close" onclick="this.parentElement.remove()" aria-label="Fermer">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            <!-- Backfill banner -->
            {% if pending_backfills > 0 %}
            <div id="backfill-banner"
                 hx-post="{{ url_for('market.trigger_backfill') }}"
                 hx-trigger="load"
                 hx-target="#backfill-banner"
                 hx-swap="outerHTML">
                <div class="backfill-banner">
                    <svg class="spinner-sm" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent-primary)" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                    <span>Synchronisation des cours historiques en cours…</span>
                </div>
            </div>
            {% endif %}
    {% endif %}

    {% block content %}{% endblock %}

    {% if current_user.is_authenticated %}
            <footer class="app-footer">
                <small>PEA Tracker — Données fournies par Yahoo Finance via yfinance</small>
            </footer>
        </main>

        <!-- Bottom nav (mobile) -->
        <nav class="bottom-nav">
            <a href="{{ url_for('portfolio.dashboard') }}"
               class="bottom-nav-link"
               {% if request.endpoint and 'dashboard' in request.endpoint %}aria-current="page"{% endif %}>
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7" rx="1"/>
                    <rect x="14" y="3" width="7" height="7" rx="1"/>
                    <rect x="3" y="14" width="7" height="7" rx="1"/>
                    <rect x="14" y="14" width="7" height="7" rx="1"/>
                </svg>
                Dashboard
            </a>
            <a href="{{ url_for('portfolio.transactions') }}"
               class="bottom-nav-link"
               {% if request.endpoint and 'transaction' in request.endpoint %}aria-current="page"{% endif %}>
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="7 17 17 7"/>
                    <polyline points="7 7 17 7 17 17"/>
                </svg>
                Transactions
            </a>
            <a href="{{ url_for('alerts.list_alerts') }}"
               class="bottom-nav-link"
               {% if request.endpoint and 'alert' in request.endpoint %}aria-current="page"{% endif %}>
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
                Alertes
            </a>
        </nav>
    </div>
    {% endif %}

    {% block scripts %}{% endblock %}

    <script>
        // Auto-dismiss toasts after 5s
        document.querySelectorAll('.toast').forEach(function(toast) {
            setTimeout(function() { toast.remove(); }, 5000);
        });
    </script>
</body>
</html>
